---
const product = { id: 1, name: "Producto X", price: 10000 };
---

<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{product.name}</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: Arial, sans-serif;
            }
            body {
                background-color: #f5f5f5;
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }
            .container {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 500px;
                overflow: hidden;
            }
            .header {
                background: #4f46e5;
                color: white;
                padding: 20px;
            }
            .header h1 {
                font-size: 24px;
                margin-bottom: 8px;
            }
            .form-container {
                padding: 20px;
            }
            fieldset {
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                margin-bottom: 20px;
                padding: 15px;
            }
            legend {
                font-weight: bold;
                margin-bottom: 10px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
                color: #374151;
                font-size: 14px;
                font-weight: bold;
            }
            .form-group input {
                width: 100%;
                padding: 10px;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                font-size: 16px;
            }
            button {
                background: #4f46e5;
                color: white;
                padding: 12px;
                border: none;
                border-radius: 4px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
            }
            button:hover {
                background: #4338ca;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>{product.name}</h1>
                <p>Precio: S/. {product.price / 100}</p>
            </div>

            <div class="form-container">
                <form id="payment-form">
                    <!-- Información de Envío -->
                    <fieldset>
                        <legend>Información de Envío</legend>
                        <div class="form-group">
                            <label for="email">Correo Electrónico</label>
                            <input
                                type="email"
                                name="email"
                                id="email"
                                placeholder="Tu email"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="first_name">Nombre</label>
                            <input
                                type="text"
                                name="first_name"
                                id="first_name"
                                placeholder="Nombre"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="last_name">Apellido</label>
                            <input
                                type="text"
                                name="last_name"
                                id="last_name"
                                placeholder="Apellido"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="address">Dirección</label>
                            <input
                                type="text"
                                name="address"
                                id="address"
                                placeholder="Dirección"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="phone_number">Teléfono</label>
                            <input
                                type="text"
                                name="phone_number"
                                id="phone_number"
                                placeholder="Teléfono"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="documentNumber">Documento</label>
                            <input
                                type="text"
                                name="documentNumber"
                                id="documentNumber"
                                placeholder="Documento"
                                required
                            />
                        </div>
                    </fieldset>

                    <!-- Información de Pago (datos de la tarjeta) -->
                    <fieldset>
                        <legend>Información de Pago</legend>
                        <div class="form-group">
                            <label for="card_number">Número de Tarjeta</label>
                            <input
                                type="text"
                                name="card_number"
                                id="card_number"
                                placeholder="4111111111111111"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input
                                type="text"
                                name="cvv"
                                id="cvv"
                                placeholder="123"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="expiration_month"
                                >Mes de Expiración</label
                            >
                            <input
                                type="text"
                                name="expiration_month"
                                id="expiration_month"
                                placeholder="09"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="expiration_year"
                                >Año de Expiración</label
                            >
                            <input
                                type="text"
                                name="expiration_year"
                                id="expiration_year"
                                placeholder="2025"
                                required
                            />
                        </div>
                    </fieldset>

                    <button type="submit">Pagar</button>
                </form>
            </div>
        </div>

        <script type="module">
            const product = { id: 1, name: "Producto X", price: 10000 };

            document
                .getElementById("payment-form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const form = e.target;

                    const email = form.email.value;
                    const firstName = form.first_name.value;
                    const lastName = form.last_name.value;
                    const address = form.address.value;
                    const phoneNumber = form.phone_number.value;
                    const documentNumber = form.documentNumber.value;

                    const card_number = form.card_number.value;
                    const cvv = form.cvv.value;
                    const expiration_month = form.expiration_month.value;
                    const expiration_year = form.expiration_year.value;

                    const tokenPayload = {
                        email,
                        card_number,
                        cvv,
                        expiration_month,
                        expiration_year,
                        metadata: { dni: documentNumber },
                    };

                    try {
                        const tokenResponse = await fetch("/api/create-token", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(tokenPayload),
                        });

                        const tokenResult = await tokenResponse.json();

                        if (!tokenResponse.ok) {
                            throw new Error(
                                tokenResult.error || "Error al crear el token",
                            );
                        }

                        const token = tokenResult.id;

                        const chargePayload = {
                            token,
                            amount: product.price,
                            currency_code: "PEN",
                            email,
                            capture: true,
                            description: product.name,
                            antifraud_details: {
                                address,
                                address_city: "Lima",
                                country_code: "PE",
                                first_name: firstName,
                                last_name: lastName,
                                phone_number: phoneNumber,
                            },
                            metadata: {
                                documentNumber,
                            },
                        };

                        const chargeResponse = await fetch("/api/charge", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(chargePayload),
                        });

                        const chargeResult = await chargeResponse.json();

                        if (chargeResponse.ok) {
                            alert(
                                "Pago exitoso!\nID del cargo: " +
                                    chargeResult.id,
                            );
                        } else {
                            throw new Error(
                                chargeResult.error || "Error al crear el cargo",
                            );
                        }
                    } catch (error) {
                        alert("Error en el proceso de pago: " + error.message);
                        console.error("Error:", error);
                    }
                });
        </script>
    </body>
</html>
