---
const { paymentId, merchantOrderId } = Astro.props;
---

<div class="shipping-section">
    <h2 class="section-title">Complete sus datos de envío</h2>
    <p class="section-desc">
        Para finalizar su pedido, necesitamos la información de entrega.
    </p>

    <form id="shipping-form" class="shipping-form">
        <input type="hidden" name="paymentId" value={paymentId} />
        <input type="hidden" name="merchantOrderId" value={merchantOrderId} />

        <div class="form-group">
            <label for="name">Nombre completo</label>
            <input
                type="text"
                id="name"
                name="name"
                required
                class="input-field"
            />
        </div>

        <div class="form-group">
            <label for="email">Email</label>
            <input
                type="email"
                id="email"
                name="email"
                required
                class="input-field"
            />
        </div>

        <div class="form-group">
            <label for="phone">Teléfono</label>
            <input
                type="tel"
                id="phone"
                name="phone"
                required
                class="input-field"
            />
        </div>

        <div class="form-group">
            <label for="address">Dirección</label>
            <input
                type="text"
                id="address"
                name="address"
                required
                class="input-field"
            />
        </div>

        <div class="form-row">
            <div class="form-group half">
                <label for="city">Ciudad</label>
                <input
                    type="text"
                    id="city"
                    name="city"
                    required
                    class="input-field"
                />
            </div>
            <div class="form-group half">
                <label for="zipcode">Código Postal</label>
                <input
                    type="text"
                    id="zipcode"
                    name="zipcode"
                    required
                    class="input-field"
                />
            </div>
        </div>

        <button type="submit" class="button submit-button">
            Guardar información de envío
        </button>
    </form>

    <div id="form-success" class="form-success hidden">
        <div class="success-icon">✓</div>
        <h3>¡Información guardada correctamente!</h3>
        <p>
            Hemos recibido tus datos de envío. Te enviaremos actualizaciones
            sobre el estado de tu pedido.
        </p>
        <a href="/" class="button primary">Volver al inicio</a>
    </div>
</div>

<script is:inline>
    document
        .getElementById("shipping-form")
        .addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;
            const submitButton = form.querySelector(".submit-button");

            // Deshabilitar el botón y mostrar estado de carga
            submitButton.disabled = true;
            submitButton.innerHTML = "Guardando...";

            try {
                const formData = new FormData(form);
                const response = await fetch("/api/save-address", {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    // Ocultar formulario y mostrar mensaje de éxito
                    form.classList.add("hidden");
                    document
                        .getElementById("form-success")
                        .classList.remove("hidden");
                } else {
                    throw new Error("Error al guardar los datos");
                }
            } catch (error) {
                console.error("Error:", error);
                // Restaurar botón y mostrar error
                submitButton.disabled = false;
                submitButton.innerHTML = "Guardar información de envío";
                alert(
                    "Hubo un problema al guardar tus datos. Por favor intenta nuevamente.",
                );
            }
        });
</script>

<style>
    .shipping-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e5e7eb;
    }

    h2,
    h3,
    p {
        color: black;
    }
    label {
        color: black;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .section-desc {
        color: black;
        margin-bottom: 1.5rem;
    }

    .shipping-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-row {
        display: flex;
        gap: 1rem;
    }

    .half {
        flex: 1;
    }

    .input-field {
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
    }

    .input-field:focus {
        outline: none;
        border-color: #3490dc;
        box-shadow: 0 0 0 3px rgba(52, 144, 220, 0.25);
    }

    .button {
        display: inline-block;
        padding: 0.75rem 1rem;
        font-weight: bold;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
        border: none;
        transition: background-color 0.2s;
        text-align: center;
    }

    .submit-button {
        background-color: #16a34a;
        color: white;
        margin-top: 1rem;
    }

    .submit-button:hover {
        background-color: #15803d;
    }

    .button.primary {
        background-color: #3490dc;
        color: white;
    }

    .button.primary:hover {
        background-color: #2779bd;
    }

    .hidden {
        display: none;
    }

    .form-success {
        text-align: center;
        padding: 2rem 0;
    }

    .success-icon {
        display: inline-flex;
        align-items: center;
        width: 4rem;
        justify-content: center;
        height: 4rem;
        background-color: #16a34a;
        color: black;
        border-radius: 50%;
        font-size: 2rem;
        margin-bottom: 1rem;
    }
</style>
