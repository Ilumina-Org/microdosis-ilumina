---
// ChatMedico.astro
---

<div class="chat-wrapper">
  <div class="chat-container" style="display: none;">
    <div class="chat-box">
      <button id="close-chat" class="close-button">×</button>
      <div class="chat-message bot">
        <p id="question-text"></p>
      </div>
      <div id="options-container" class="options"></div>
      <div id="thinking" class="thinking">
        <div class="loading-spinner"></div>
        <p>Analizando tus respuestas...</p>
      </div>
      <div id="result-container" class="result-container">
        <p id="result" class="result"></p>
        <button id="restart-chat" class="restart-button">Realizar otra consulta</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Estilos base del chatbot */
  .chat-wrapper {
    position: absolute; /* Contenedor base */
    min-height: '10rem',
    min-width: '10rem',
    border:'1px solid white',
    right: '2rem',
    bottom: '2rem',
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .chat-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .chat-toggle:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
  }

  .robot-icon {
    width: 30px;
    height: 30px;
    color: white;
  }

  /* Contenedor principal del chat */
  .chat-container {
  position: fixed;  /* Fija el elemento en la pantalla */
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000; /* Asegura que esté por encima de otros elementos */
}


  .chat-box {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    padding: 20px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    margin-bottom: 20px;
    scrollbar-width: thin;
    scrollbar-color: #4CAF50 #f5f5f5;
  }

  .chat-box::-webkit-scrollbar {
    width: 8px;
  }

  .chat-box::-webkit-scrollbar-track {
    background: #f5f5f5;
    border-radius: 10px;
  }

  .chat-box::-webkit-scrollbar-thumb {
    background-color: #4CAF50;
    border-radius: 10px;
  }

  /* Botón de cerrar */
  .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #f5f5f5;
    border: none;
    font-size: 16px;
    color: #333;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 50%;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
  }

  .close-button:hover {
    background: #e0e0e0;
    color: #000;
  }

  /* Mensajes del chatbot */
  .chat-message {
    background: #e8f5e9;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #4CAF50;
  }

  .chat-message p {
    color: #333;
    font-size: 16px;
    line-height: 1.5;
    margin: 0;
  }

  /* Contenedor de opciones */
  .options {
    display: grid;
    gap: 12px;
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
    padding-right: 5px;
  }

  /* Estilos para botones normales */
  .button {
    width: 100%;
    text-align: left;
    padding: 12px 16px;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    color: #333;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  .button:hover {
    background: #f9fafb;
    border-color: #4CAF50;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* Animación de carga */
  .thinking {
    display: none;
    text-align: center;
    padding: 20px 0;
  }

  .loading-spinner {
    border: 3px solid #f3f3f3;
    border-radius: 50%;
    border-top: 3px solid #4CAF50;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Contenedor de resultados */
  .result-container {
    display: none;
    text-align: center;
  }

  .result {
    font-size: 16px;
    line-height: 1.6;
    font-weight: normal;
    color: #333;
    background: #e8f5e9;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #4CAF50;
    text-align: left;
    white-space: pre-line;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  }

  /* Botón de reinicio */
  .restart-button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 10px;
    font-weight: 500;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .restart-button:hover {
    background: #388E3C;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  /* Estilos responsivos */
  @media (max-width: 768px) {
    .chat-container {
      bottom: 80px;
      right: 10px;
      left: 10px;
      width: auto;
      max-width: none;
    }

    .chat-box {
      border-radius: 12px;
      padding: 16px;
    }

    .chat-message p {
      font-size: 15px;
    }

    .button {
      font-size: 14px;
      padding: 10px 14px;
    }

    .result {
      font-size: 15px;
      padding: 16px;
    }
  }

  @media (max-width: 480px) {
    .chat-toggle {
      width: 50px;
      height: 50px;
    }

    .robot-icon {
      width: 25px;
      height: 25px;
    }

    .close-button {
      font-size: 14px;
      width: 26px;
      height: 26px;
    }

    .options {
      max-height: 250px;
    }
  }

  /* Selección múltiple mejorada */
  .multi-select {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    width: 100%;
    margin-bottom: 15px;
  }

  @media (max-width: 600px) {
    .multi-select {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 400px) {
    .multi-select {
      grid-template-columns: 1fr;
    }
  }

  .checkbox-option {
    display: flex;
    align-items: center;
    background: #f3f4f6;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
  }

  .checkbox-option
            margin-bottom: 10px;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }

        .option.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }


  .checkbox-option:hover {
    background: #e5e7eb;
    transform: translateY(-2px);
  }

  .checkbox-option.selected {
    background: #dcfce7;
    border: 1px solid #4CAF50;
  }

  .checkbox-option input {
    margin-right: 8px;
  }

  /* Botón continuar mejorado */
  .continue-button {
    width: 100%;
    background: #4CAF50;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .continue-button:hover {
    background: #388E3C;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  .continue-button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* Mejoras para la lista de diagnósticos */
  /* Este estilo se aplicará específicamente a la pregunta de diagnósticos */
  .options.diagnosis-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
  }

  @media (max-width: 600px) {
    .options.diagnosis-options {
      grid-template-columns: 1fr;
    }
  }
</style>
<script>
const questions = [
  {
    id: 1,
    text: "Bienvenido a nuestro asistente de evaluación. ¿Deseas saber cual es tu dosis correcta de ayahuasca para sanar?",
    options: ["Sí, continuar", "Más información", "No, gracias"]
  },
  {
    id: 2,
    text: "¿Cuántos años tienes?",
    options: ["De 17 a 34 años", "De 35 a 54 años", "De 55 a 74 años", "De 75 a más"]
  },
  {
    id: 3,
    text: "¿Cuál es tu peso actual?",
    options: ["De 40 a 54 kg", "De 55 a 64 kg", "De 65 a 84 kg", "De 85 kg a más"]
  },
  {
    id: 4,
    text: "¿Tienes algún diagnóstico?",
    options: ["Sí", "No"]
  },
  {
    id: 5,
    text: "¿Qué diagnóstico tienes?",
    options: [
      "Ansiedad", "Depresión", "Diabetes", "Migraña", "Presión Alta",
      "Presión Baja", "Insomnio", "Gastritis", "Hipertiroidismo",
      "Hipotiroidismo", "Cáncer", "Artritis", "Artrosis", "Parkinson",
      "Alzheimer", "Asma", "Próstata", "Dermatitis", "Hepatitis",
      "Colon Irritable", "ETS", "Esquizofrenia", "Paranoia", "Demencia"
    ]
  },
  {
    id: 6,
    text: "¿Toma algún medicamento?",
    options: ["Sí", "No"]
  },
  {
    id: 7,
    text: "¿En qué momento del día tomas tus medicamentos?",
    type: "multiselect",
    options: ["Mañana", "Tarde", "Noche"]
  },
  {
    id: 8,
    text: "¿Qué estás buscando con la microdosis?",
    options: [
      "Despertar espiritual y meditación",
      "Mejorar la concentración y creatividad",
      "Mejorar calidad de sueño",
      "Más energía y productividad"
    ]
  }
];

const resultInfo = {
  "Más información":
    "Este cuestionario evalúa la aptitud para el uso de la microdosis de ayahuasca. Es importante responder con honestidad para recibir recomendaciones apropiadas. Los resultados son orientativos y no reemplazan la consulta profesional.",

  "No, gracias":
    "Entendemos. Si en otro momento deseas realizar la evaluación, estaremos aquí para ayudarte."
};

// Valores de gotas por edad
const edadGotas = {
  "De 17 a 34 años": 6,
  "De 35 a 54 años": 7,
  "De 55 a 74 años": 5,
  "De 75 a más": 4
};

// Valores de gotas por peso
const pesoGotas = {
  "De 40 a 54 kg": 5,
  "De 55 a 64 kg": 7,
  "De 65 a 84 kg": 8,
  "De 85 kg a más": 7
};

// Valores de ajuste por enfermedad con horas de espera
const enfermedadData = {
  "Ansiedad": { ajuste: 1, horas: 1 },
  "Depresión": { ajuste: 1, horas: 1 },
  "Diabetes": { ajuste: 2, horas: 2 },
  "Migraña": { ajuste: 1, horas: 1 },
  "Presión Alta": { ajuste: 2, horas: 2 },
  "Presión Baja": { ajuste: 2, horas: 2 },
  "Insomnio": { ajuste: 1, horas: 1 },
  "Gastritis": { ajuste: 3, horas: 2 },
  "Hipertiroidismo": { ajuste: 3, horas: 2 },
  "Hipotiroidismo": { ajuste: 3, horas: 2 },
  "Cáncer": { ajuste: 3, horas: 3 },
  "Artritis": { ajuste: 3, horas: 2 },
  "Artrosis": { ajuste: 3, horas: 2 },
  "Parkinson": { ajuste: 4, horas: 1 },
  "Alzheimer": { ajuste: 4, horas: 1 },
  "Asma": { ajuste: 2, horas: 1 },
  "Próstata": { ajuste: 2, horas: 1 },
  "Dermatitis": { ajuste: 2, horas: 1 },
  "Hepatitis": { ajuste: 3, horas: 1 },
  "Colon Irritable": { ajuste: 3, horas: 1 },
  "ETS": { ajuste: 4, horas: 3 },
  "Esquizofrenia": { ajuste: -1, horas: 2 },
  "Paranoia": { ajuste: -1, horas: 2 },
  "Demencia": { ajuste: -2, horas: 2 }
};

let step = 0;
let respuestas = [];
let gotasCalculadas = 0;
let tieneEnfermedad = false;
let tomaMedicamentos = false;
let momentoMedicacion = [];
let diagnosticoSeleccionado = "";
let horasEspera = 1;

// Elementos DOM
const toggleButton = document.getElementById('toggle-chat');
const closeButton = document.getElementById('close-chat');
const chatContainer = document.querySelector('.chat-container');
const restartButton = document.getElementById('restart-chat');
const resultContainer = document.getElementById('result-container');

// Toggle chat
toggleButton.addEventListener('click', () => {
  chatContainer.style.display = chatContainer.style.display === 'none' ? 'block' : 'none';
});

// Close chat
closeButton.addEventListener('click', () => {
  chatContainer.style.display = 'none';
});

// Restart chat
restartButton.addEventListener('click', () => {
  step = 0;
  respuestas = [];
  gotasCalculadas = 0;
  tieneEnfermedad = false;
  tomaMedicamentos = false;
  momentoMedicacion = [];
  diagnosticoSeleccionado = "";
  horasEspera = 1;
  resultContainer.style.display = 'none';
  document.querySelector("#question-text").style.display = 'block';
  document.querySelector("#options-container").style.display = 'grid';
  updateQuestion();
});

// Remove the TypeScript annotation and fix the function
function handleMultiSelect() {
  // Get all selected checkbox options
  const selectedOptions = document.querySelectorAll('.checkbox-option.selected');

  console.log("Selected options:", selectedOptions); // Debug
  momentoMedicacion = [];
  // Extract the values from selected options
  selectedOptions.forEach(option => {
    console.log("Processing option:", option, "with value:", option.dataset.value);
    momentoMedicacion.push(option.dataset.value);
  });

  console.log("Selected medication times:", momentoMedicacion);

  // Advance to the next step
  step++;
  if (step < questions.length) {
    updateQuestion();
  } else {
    showThinkingAnimation();
  }
}

function nextQuestion(answer) {
  respuestas.push(answer);

  if (step === 0 && (answer === "Más información" || answer === "No, gracias")) {
    showSpecialResult(answer);
    return;
  }

  // Lógica para calcular gotas
  if (step === 1) { // Respuesta de edad
    gotasCalculadas += edadGotas[answer] || 0;
  }
  else if (step === 2) { // Respuesta de peso
    gotasCalculadas += pesoGotas[answer] || 0;
    // Dividir por 2 para obtener promedio
    gotasCalculadas = Math.round(gotasCalculadas / 2);
  }
  else if (step === 3) { // ¿Tiene diagnóstico?
    tieneEnfermedad = (answer === "Sí");
  }
  else if (step === 4 && tieneEnfermedad) { // Tipo de diagnóstico
    diagnosticoSeleccionado = answer;
    const data = enfermedadData[answer] || { ajuste: 0, horas: 1 };
    gotasCalculadas += data.ajuste;
    horasEspera = data.horas;
  }
  else if (step === 5 && tieneEnfermedad) { // ¿Toma medicamentos?
    tomaMedicamentos = (answer === "Sí");
  }

  step++;

  // Lógica para saltar preguntas según respuestas
  if (!tieneEnfermedad && step === 4) {
    step = 7; // Saltar a la última pregunta
  }
  else if (!tomaMedicamentos && tieneEnfermedad && step === 6) {
    step = 7; // Saltar a la última pregunta
  }

  if (step < questions.length) {
    updateQuestion();
  } else {
    showThinkingAnimation();
  }
}

function showSpecialResult(answer) {
  const questionText = document.querySelector("#question-text");
  const optionsContainer = document.querySelector("#options-container");
  resultContainer.style.display = 'block';
  const resultText = document.querySelector("#result");

  questionText.style.display = "none";
  optionsContainer.style.display = "none";
  resultText.textContent = resultInfo[answer];
}

function updateQuestion() {
  const questionText = document.querySelector("#question-text");
  const optionsContainer = document.querySelector("#options-container");

  if (questionText && optionsContainer) {
    questionText.textContent = questions[step].text;
    optionsContainer.innerHTML = "";

    if (questions[step].type === "multiselect") {
      // Crear selección múltiple para horarios de medicación
      const multiSelectContainer = document.createElement("div");
      multiSelectContainer.className = "multi-select";

      questions[step].options.forEach((option) => {
        const checkboxOption = document.createElement("div");
        checkboxOption.className = "checkbox-option";
        checkboxOption.dataset.value = option;
        checkboxOption.textContent = option;


        checkboxOption.style.marginBottom = "10px";
        checkboxOption.style.padding = "10px";
        checkboxOption.style.backgroundColor = "#fff";
        checkboxOption.style.border = "1px solid #ddd";
        checkboxOption.style.borderRadius = "4px";
        checkboxOption.style.cursor = "pointer";
        checkboxOption.style.userSelect = "none";
        checkboxOption.style.transition = "background-color 0.3s";

        checkboxOption.addEventListener("click", function()  {
          checkboxOption.classList.toggle("selected");
            const isCurrentlySelected = this.style.backgroundColor === "rgb(76, 175, 80)";

                    // Cambiar estilos según el estado de selección
                    if (isCurrentlySelected) {
                        // Deseleccionar
                        this.style.backgroundColor = "#fff";
                        this.style.color = "";
                        this.style.borderColor = "#ddd";
                    } else {
                        // Seleccionar
                        this.style.backgroundColor = "#4CAF50";
                        this.style.color = "white";
                        this.style.borderColor = "#4CAF50";
                    }
          console.log(checkboxOption.classList);
        });

        multiSelectContainer.appendChild(checkboxOption);
      });

      optionsContainer.appendChild(multiSelectContainer);

      // Botón para continuar
      const continueButton = document.createElement("button");
      continueButton.textContent = "Continuar";
      continueButton.className = "continue-button";
      continueButton.addEventListener("click", handleMultiSelect);

      optionsContainer.appendChild(continueButton);
    } else {
      // Opciones normales de botón único
      questions[step].options.forEach((option) => {
        const button = document.createElement("button");
        button.textContent = option;
        button.className = "button";

        // Estilos directamente en línea
        button.style.background = "linear-gradient(135deg, #007bff, #0056b3)";
        button.style.color = "white";
        button.style.border = "none";
        button.style.padding = "12px 24px";
        button.style.borderRadius = "8px";
        button.style.cursor = "pointer";
        button.style.transition = "all 0.3s ease";
        button.style.fontSize = "14px";
        button.style.fontWeight = "bold";
        button.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
        button.style.textTransform = "uppercase";
        button.style.letterSpacing = "0.5px";
        button.style.minWidth = "100px";
        button.style.outline = "none";


        button.addEventListener("click", () => nextQuestion(option));
        optionsContainer.appendChild(button);
      });
    }
  }
}

function showThinkingAnimation() {
  const questionText = document.querySelector("#question-text");
  const optionsContainer = document.querySelector("#options-container");
  const thinkingElement = document.querySelector("#thinking");

  questionText.style.display = "none";
  optionsContainer.style.display = "none";
  thinkingElement.style.display = "block";

  setTimeout(() => {
    showResult();
  }, 1500);
}


// Parte modificada para usar tiempos específicos basados en el diagnóstico

// En la función showResult(), modifica la parte donde se generan las instrucciones:

function showResult() {
  const thinkingElement = document.querySelector("#thinking");
  const resultText = document.querySelector("#result");
  thinkingElement.style.display = "none";
  resultContainer.style.display = 'block';

  // Asegurar que la dosis no sea negativa
  if (gotasCalculadas < 0) {
    gotasCalculadas = 0;
  }

  let instrucciones = "";

  if (gotasCalculadas === 0) {
    instrucciones = "Basado en tus respuestas, no recomendamos el uso de microdosis de ayahuasca en este momento. Por favor consulta con un profesional de la salud.";
  } else {
    // Instrucciones básicas
    let instruccionesBasicas = `✨ Tu dosis recomendada es de ${gotasCalculadas} gotas, dos veces al día.\n\n`;

    // Instrucciones para la mañana - CORREGIDA con instrucciones de medicamentos
    let instruccionesMañana = `✨ Por la mañana: Apenas te despiertas y en ayunas, antes de lavarte los dientes y antes de tomar agua, se echan ${gotasCalculadas} gotas bajo la lengua; dejan que pase un minuto bajo la lengua y luego pasan lo que resta; luego de media hora ya te puedes lavar los dientes y tomar agua, luego de media hora más ya puedes tomar tu desayuno`;

    if (tomaMedicamentos && momentoMedicacion.includes("Mañana")) {
      instruccionesMañana += ` y después de una hora de la microdosis ya puedes tomar tus medicamentos.\n`;
    } else {
      instruccionesMañana += `.\n`;
    }

    // Instrucciones para la noche - CORREGIDA para tomar medicamentos ANTES de la microdosis
    let instruccionesNoche = `\n✨ Por la noche: Tener en cuenta que tu última comida debe ser máximo a las 8 pm (luego de esa hora el estómago ya no hace digestión). `;

    if (tomaMedicamentos && momentoMedicacion.includes("Noche")) {
      instruccionesNoche += `Toma tus medicamentos inmediatamente después de la cena y después de hora y media tomas las ${gotasCalculadas} gotas de microdosis de ayahuasca.\n`;
    } else {
      instruccionesNoche += `Después de hora y media de haber cenado, tomas las ${gotasCalculadas} gotas de microdosis de ayahuasca.\n`;
    }

    // Añadir nota específica sobre medicamentos si seleccionó ambos momentos
    let notaMedicamentos = "";
    if (tomaMedicamentos && momentoMedicacion.includes("Mañana") && momentoMedicacion.includes("Noche")) {
      notaMedicamentos = `\n🚫 IMPORTANTE: Recuerda que el orden es diferente: en la mañana primero tomas la microdosis y DESPUÉS los medicamentos (1 hora después), mientras que en la noche primero tomas los medicamentos y DESPUÉS la microdosis (1.5 horas después).\n`;
    }

    // Instrucciones de calendario
    let instruccionesCalendario = `\n✨ Se toma dos días sí y uno no; por ejemplo, empiezas martes y miércoles y descansas de la medicina el jueves, vuelves a tomar viernes y sábado y descansas domingo.\n`;

    // Restricciones y cuidados
    let restricciones = `\n🚫 Si tomas alcohol no tomar ayahuasca. Se deja ese día la medicina y se empieza al siguiente día como día uno.\n`;

    // Instrucciones específicas para el diagnóstico
    let instruccionesDiagnostico = "";
    if (tieneEnfermedad && diagnosticoSeleccionado) {
      instruccionesDiagnostico = `\n✨ Nota para tu diagnóstico de ${diagnosticoSeleccionado}: Se ha ajustado tu dosis considerando esta condición. Recuerda mantener un seguimiento de cómo te sientes durante el tratamiento.\n`;
    }

    // Instrucciones de conservación y dieta
    let conservacion = `\n🌿 Mantener la microdosis en un lugar fresco. El frasco abierto tiene vencimiento en 6 meses.\n`;

    let dieta = `\n🌿 Durante la toma de las microdosis hay que tener coherencia en la alimentación, evitar en lo máximo la carne de res y chancho, no café, no gaseosas, no comida chatarra, comidas bajas en azúcar y harinas.\n`;

    instrucciones = instruccionesBasicas + instruccionesMañana + instruccionesNoche + notaMedicamentos + instruccionesCalendario + restricciones + instruccionesDiagnostico + conservacion + dieta;
  }

  resultText.textContent = instrucciones;
}
// Inicializar el chat
document.addEventListener("DOMContentLoaded", () => {
  updateQuestion();
});
</script>
