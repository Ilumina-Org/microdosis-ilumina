---
// ChatMedico.astro
---

<div class="chat-wrapper">
  <button id="toggle-chat" class="chat-toggle">
    <div class="robot-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="robot-svg">
        <rect x="3" y="11" width="18" height="10" rx="2"/>
        <circle cx="12" cy="5" r="2"/>
        <path d="M12 7v4"/>
        <line x1="8" y1="16" x2="8" y2="16"/>
        <line x1="16" y1="16" x2="16" y2="16"/>
      </svg>
    </div>
  </button>

  <div class="chat-container" style="display: none;">
    <div class="chat-box">
      <button id="close-chat" class="close-button">×</button>
      <div class="chat-message bot">
        <p id="question-text"></p>
      </div>
      <div id="options-container" class="options"></div>
      <div id="thinking" class="thinking">
        <div class="loading-spinner"></div>
        <p>Analizando tus respuestas...</p>
      </div>
      <div id="result-container" class="result-container">
        <p id="result" class="result"></p>
        <button id="restart-chat" class="restart-button">Realizar otra consulta</button>
      </div>
    </div>
  </div>
</div>

<style>
  .chat-wrapper {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  .chat-toggle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #3b82f6;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .chat-toggle:hover {
    transform: scale(1.1);
    background: #2563eb;
  }

  .robot-icon {
    width: 30px;
    height: 30px;
    color: white;
  }

  .robot-svg {
    width: 100%;
    height: 100%;
  }

  .chat-container {
    position: fixed;
    bottom: 90px;
    right: 20px;
    z-index: 1000;
  }

  .chat-box {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    padding: 24px;
    width: 100%;
    max-width: 480px;
    position: relative;
    margin-bottom: 20px;
  }

  .close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    color: #6b7280;
    cursor: pointer;
    padding: 5px 5px;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .close-button:hover {
    background: #f3f4f6;
    color: #374151;
  }

  .chat-message {
    background: #eef2ff;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 20px;
  }

  .chat-message p {
    color: #1f2937;
    font-size: 1.125rem;
    line-height: 1.5;
    margin: 0;
  }

  .options {
    display: grid;
    gap: 12px;
    margin-top: 20px;
  }

  .button {
    width: 100%;
    text-align: left;
    padding: 12px 16px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    color: #374151;
    font-size: 0.975rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .button:hover {
    background: #f9fafb;
    border-color: #3b82f6;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .thinking {
    display: none;
    text-align: center;
    padding: 20px 0;
  }

  .loading-spinner {
    border: 3px solid #f3f3f3;
    border-radius: 50%;
    border-top: 3px solid #3b82f6;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 12px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .result-container {
    display: none;
    text-align: center;
  }

  .result {
    font-size: 1.125rem;
    font-weight: 500;
    color: #1f2937;
    background: #f0f9ff;
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    border: 1px solid #bfdbfe;
  }

  .restart-button {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
  }

  .restart-button:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  @media (max-width: 640px) {
    .chat-container {
      bottom: 80px;
      right: 10px;
      left: 10px;
    }
    
    .chat-box {
      max-width: none;
    }
  }
</style>

<script>
const questions = [
  {
      id: 1,
      text: "Bienvenido a nuestro asistente de evaluación. ¿Deseas continuar con el cuestionario de aptitud?",
      options: ["Sí, continuar", "Más información", "No, gracias"]
    },
    {
      id: 2,
      text: "¿Tienes antecedentes de condiciones cardíacas o presión arterial alta?",
      options: ["Sí", "No", "No estoy seguro"]
    },
    {
      id: 3,
      text: "¿Estás tomando actualmente algún medicamento antidepresivo o ansiolítico?",
      options: ["Sí", "No", "Lo dejé hace más de 2 meses"]
    },
    {
      id: 4,
      text: "¿Has experimentado episodios de ansiedad severa o ataques de pánico?",
      options: ["Sí, recientemente", "Sí, hace tiempo", "No, nunca"]
    },
    {
      id: 5,
      text: "¿Cuál es tu nivel de experiencia con medicinas tradicionales?",
      options: ["Primera vez", "Alguna experiencia", "Experiencia regular"]
    },
    {
      id: 6,
      text: "¿Cuál es tu peso aproximado?",
      options: ["Menos de 60kg", "Entre 60-80kg", "Más de 80kg"]
    }
  ];

const results = {
    // No apto
    "Sí, continuar,Sí,Sí,Sí, recientemente": 
      "Basado en tus respuestas, no recomendamos el uso del producto en este momento. Por favor consulta con un profesional de la salud antes de considerar su uso.",
    
    // Precaución
    "Sí, continuar,No,Sí,No, nunca": 
      "Debido a tu medicación actual, recomendamos esperar al menos 2 meses después de discontinuar los medicamentos (bajo supervisión médica) antes de considerar el uso del producto.",
    
    // Apto con dosis mínima
    "Sí, continuar,No,No,No, nunca,Primera vez,Menos de 60kg": 
      "Basado en tu perfil, podrías comenzar con 2 gotas por la mañana, 3 veces por semana. Mantén este régimen por 2 semanas antes de considerar ajustes. Recuerda mantener un diario de experiencias.",
    
    // Apto con dosis estándar
    "Sí, continuar,No,No,No, nunca,Alguna experiencia,Entre 60-80kg": 
      "Tu perfil sugiere que podrías comenzar con 3 gotas por la mañana, 3 veces por semana. Evalúa los efectos durante 2 semanas antes de considerar ajustes. Mantén un registro diario de tus experiencias.",
    
    // Apto con dosis ajustada
    "Sí, continuar,No,No,No, nunca,Experiencia regular,Más de 80kg": 
      "Dado tu perfil y experiencia, podrías comenzar con 4 gotas por la mañana, 3 veces por semana. Mantén esta dosis por 2 semanas antes de considerar ajustes. Es importante llevar un registro diario.",

    // Respuestas especiales
    "Más información": 
      "Este cuestionario evalúa la aptitud para el uso de la microdosis de ayahuasca. Es importante responder con honestidad para recibir recomendaciones apropiadas. Los resultados son orientativos y no reemplazan la consulta profesional.",
    
    "No, gracias": 
      "Entendemos. Si en otro momento deseas realizar la evaluación, estaremos aquí para ayudarte."
  };

  let step = 0;
  let answers = [];

  // Elementos DOM
  const toggleButton = document.getElementById('toggle-chat');
  const closeButton = document.getElementById('close-chat');
  const chatContainer = document.querySelector('.chat-container');
  const restartButton = document.getElementById('restart-chat');
  const resultContainer = document.getElementById('result-container');

  // Toggle chat
  toggleButton.addEventListener('click', () => {
    chatContainer.style.display = chatContainer.style.display === 'none' ? 'block' : 'none';
  });

  // Close chat
  closeButton.addEventListener('click', () => {
    chatContainer.style.display = 'none';
  });

  // Restart chat
  restartButton.addEventListener('click', () => {
    step = 0;
    answers = [];
    resultContainer.style.display = 'none';
    document.querySelector("#question-text").style.display = 'block';
    document.querySelector("#options-container").style.display = 'grid';
    updateQuestion();
  });

  function nextQuestion(answer) {
    answers.push(answer);
    
    if (answer === "Más información" || answer === "No, gracias") {
      showSpecialResult(answer);
      return;
    }
    
    step++;

    if (step < questions.length) {
      updateQuestion();
    } else {
      showThinkingAnimation();
    }
  }

  function showSpecialResult(answer) {
    const questionText = document.querySelector("#question-text");
    const optionsContainer = document.querySelector("#options-container");
    resultContainer.style.display = 'block';
    const resultText = document.querySelector("#result");

    questionText.style.display = "none";
    optionsContainer.style.display = "none";
    resultText.textContent = results[answer];
  }

  function updateQuestion() {
    const questionText = document.querySelector("#question-text");
    const optionsContainer = document.querySelector("#options-container");

    if (questionText && optionsContainer) {
      questionText.textContent = questions[step].text;
      optionsContainer.innerHTML = "";

      questions[step].options.forEach((option) => {
        const button = document.createElement("button");
        button.textContent = option;
        button.className = "button";

// Estilos directamente en línea
    button.style.background = "linear-gradient(135deg, #007bff, #0056b3)";
    button.style.color = "white";
    button.style.border = "none";
    button.style.padding = "12px 24px";
    button.style.borderRadius = "8px";
    button.style.cursor = "pointer";
    button.style.transition = "all 0.3s ease";
    button.style.fontSize = "14px";
    button.style.fontWeight = "bold";
    button.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
    button.style.textTransform = "uppercase";
    button.style.letterSpacing = "0.5px";
    button.style.minWidth = "100px";
    button.style.outline = "none";


        button.addEventListener("click", () => nextQuestion(option));
        optionsContainer.appendChild(button);
      });
    }
  }

  function showThinkingAnimation() {
    const questionText = document.querySelector("#question-text");
    const optionsContainer = document.querySelector("#options-container");
    const thinkingElement = document.querySelector("#thinking");

    questionText.style.display = "none";
    optionsContainer.style.display = "none";
    thinkingElement.style.display = "block";

    setTimeout(() => {
      showResult();
    }, 1500);
  }

  function showResult() {
    const key = answers.join(",");
    const thinkingElement = document.querySelector("#thinking");
    const resultText = document.querySelector("#result");

    thinkingElement.style.display = "none";
    resultContainer.style.display = 'block';
    resultText.textContent = results[key] || "Basado en tus respuestas, te recomendamos consultar con un profesional de la salud para una evaluación más detallada.";
  }

  // Inicializar el chat
  document.addEventListener("DOMContentLoaded", () => {
    updateQuestion();
  });
</script>
